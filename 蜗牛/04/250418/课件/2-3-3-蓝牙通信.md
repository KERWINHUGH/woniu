## 蓝牙通信

### 课程目标 

1. 了解蓝牙通信特点
2. 使用JDY-25M模块进行蓝牙通信
3. 使用JDY-25M模块进行蓝牙Mesh组网

### 课程实验

使用JDY-25M进行蓝牙通信控制

### 课堂引入

最常见的通信方式之一。

### 简介

蓝牙是一种支持设备短距离通信（一般10m内）的无线电技术，可实现固定设备、移动设备和楼宇个人域网之间的短距离数据交换(使用2.4—2.485GHz的ISM波段的UHF无线电波)。常应用于汽车领域、工业生产、医疗保健、运动健身、安防、家庭娱乐等。

蓝牙设备容纳蓝牙模块，支持蓝牙无线电连接与软件应用。当两台蓝牙设备想要相互交流时，它们需要在一定范围内进行配对。蓝牙设备之间的通信在短程临时网络模式中进行，这种网络可容纳两至八台设备进行连接。当网络环境创建成功，一台设备作为主设备，而所有其它设备作为从设备，可以容纳的从设备最多不超过8台。

#### 技术特点

1. 蓝牙技术的适用设备多，无需电缆，通过无线使电脑和电信连网进行通信。
2. 蓝牙技术的工作频段全球通用，适用于全球范围内用户无界限的使用，解决了蜂窝式移动电话的“国界”障碍。蓝牙技术产品使用方便，利用蓝牙设备可以搜索到另外一个蓝牙技术产品，迅速建立起两个设备之间的联系，在控制软件的作用下，可以自动传输数据。 
3. 蓝牙技术的安全性和抗干扰能力强，由于蓝牙技术具有跳频的功能，有效避免了ISM频带遇到干扰源。蓝牙技术的兼容性较好，蓝牙技术已经能够发展成为独立于操作系统的一项技术，实现了各种操作系统中良好的兼容性能。 
4. 传输距离较短：现阶段，蓝牙技术的主要工作范围在10米左右，经过增加射频功率后的蓝牙技术可以在100米的范围进行工作，只有这样才能保证蓝牙在传播时的工作质量与效率，提高蓝牙的传播速度。另外，在蓝牙技术连接过程中还可以有效的降低该技术与其他电子产品之间的干扰，从而保证蓝牙技术可以正常运行。蓝牙技术不仅有较高的传播质量与效率，同时还具有较高的传播安全性特点。 
5. 通过跳频扩频技术进行传播：蓝牙技术在实际应用期间，可以原有的频点进行划分、转化，如果采用一些跳频速度较快的蓝牙技术，那么整个蓝牙系统中的主单元都会通过自动跳频的形式进行转换，从而将其以随机的进行跳频。由于蓝牙技术的本身具有较高的安全性与抗干扰能力，在实际应用期间可以蓝牙运行的质量。

#### 各版本的区别

![image-20231206111302746](https://woniumd.oss-cn-hangzhou.aliyuncs.com/aiot/luozhaoyong/image-20231206111302746.png)

### 蓝牙Mesh

蓝牙Mesh网络支持多对多(m:m)设备通信，并针对创建大规模设备网络的需求进行了优化。它非常适合楼宇自动化、传感器网络、资产跟踪和其他需要数十、数百或数千台设备相互通信的物联网(IoT)解决方案。

与其他低功耗无线Mesh网络技术不同，蓝牙Mesh网络是一个完整的全栈解决方案，它定义了从物理无线电层到应用层的所有技术规范。除了有助于实现更简单的产品开发和更高级的产品互操作性之外，这种全栈解决方案还可以实现更快、更顺畅的技术迭代与演进。

#### 蓝牙Mesh特点

1. 蓝牙Mesh网络采用一种称为“网络泛洪（flooding）”的方式来发布和中继消息。这意味着消息不会通过某一过程进行路由,  也不会沿着由一系列特定设备构成的特定路径来进行传输。相反，传输范围内的所有设备都会接收消息，负责中继的设备能将消息转发至其传输范围内的所有其他设备。 
2. 网络泛洪的优势在于无需特定设备专门扮演集中式路由器的角色。集中式路由器一旦发生故障，就可能会导致整个网络无法运行，从而影响网络通信的可靠性。
3. 网络泛洪的方式也意味着消息一般能够通过多重路径到达其目的地，路径中一个或多个节点的故障并不会影响其他路径上的消息传递，这就构建了一个相当可靠的网络。 
4. 中继设备能够转发从其他设备接收到的消息。在转发消息时，它们能够与位于初始消息发布设备无线范围以外的设备进行通信。消息可多次被中继，每一次中继即为一“跳”，最多可进行127跳(每一条消息允许的跳数决定其存在时间-time to life)，足以在一片广阔的物理区域中进行消息传输。 
5. 蓝牙Mesh网络通信相较一般蓝牙微微网(Piconet)通信的最大差异是其绝大部份消息传递是基于无连接传输模式 (connectionless)，绝大多数节点间并不存在传统意义上的“连接”。

#### 拓扑结构

![image-20231206112208482](https://woniumd.oss-cn-hangzhou.aliyuncs.com/aiot/luozhaoyong/image-20231206112208482.png)

**蓝色节点**为普通终端节点，不能中继网络消息，但可以直接从网络接收消息也可直接向网络发送消息。

**黄色节点**为低功耗节点，这些节点通常由电池供电，其仅与关联的朋友节点通信并通过朋友节点间接收发网络消息。

**红色节点**为中继节点，起到消息中继的作用，是实现网络消息远距离传输的关键。

**紫色节点**为朋友节点，在低功耗节点和网络间传递消息。

图中S节点与T节点间的通信使用基于低功耗蓝牙ACL连接的GATT承载；其余节点间的通信均使用基于低功耗蓝牙广播的广播承载。

#### 通信机制

蓝牙Mesh网络是以消息为中心的通信网络。 

蓝牙Mesh网络使用发布/订阅 (Publish/Subscribe)消息系统。

设备可以将消息发送至特定地址(单播)或地址群(群组)，这些地址的名称和含义与用户能够理解的高级概念相对应，如“厨房灯”(Kitchen Lights)。这被称为“发布”(Publish)。

设备经配置后，可接收由其他设备发送到特定地址的消息。这被称为“订阅”(Subscribe)。

当设备向特定地址发布消息时，订阅该地址的所有其他设备将收到该地址的副本，对其进行处理，并以某种方式作出回应。

由于节点之间的相互控制关系往往不是一对一的简单模式，引入发布和订阅的概念后将控制关系本身与物理节点独立出来，从而各节点可以通过特定的配置过程来实现复杂的控制关系并可以减少节点维护的工作量。

#### 地址类型

蓝牙Mesh网络定义了四种地址类型，其中的三类用于消息的传送：单播（unicast）地址、虚拟（virtual）地址和群组（group）地址。第四种被称为未分配（unassigned）地址。 

**未分配地址（Unassigned Address）0000000000000000**：未经配置的节点元素或未被指定地址的节点元素拥有的就是未分配地址。鉴于这些节点元素没有唯一的地址，它们不会用于消息传送。 

**单播地址（Unicast Address）0xxxxxxxxxxxxxxx** :  在“启动配置”（provisioning）期间，启动配置设备（provisioner）会在网络节点的生命周期内为节点中的每个节点元素(一个节点Node可以有多个节点元素Element,  例如一个多孔插座作为一个节点，插座上的每一个插孔都是一个独立的节点元素)分配一个单播地址。单播地址可能出现在消息的源地址字段或目的地址字段中。发送到单播地址的消息只能由一个节点元素进行处理。 

**虚拟地址（Virtual Address）10xxxxxxxxxxxxxx** : 虚拟地址是与特定的UUID标签相关联的一组节点元素；这些地址可能会被用于消息发布或订阅。UUID标签是与多个来自一个或多个节点的元素相关联的128位值。 

**群组地址（Group Address）11xxxxxxxxxxxxxx** : 群组地址是蓝牙Mesh网络中的另一种多播地址（multicast address），它通常代表一个或多个节点中的多个节点元素。 Mesh规范中定义的四种固定群组地址如下: 

- **1111111111111100,** 所有代理节点
- **1111111111111101**, 所有朋友节点
- **1111111111111110**, 所有中继节点
- **1111111111111111**, 所有节点

#### 网络极限

根据《Mesh Profile》蓝牙技术规范蓝牙Mesh网络的能力极限如下:

每个Mesh网络中的元素数量(一点节点可以有一个或多个元素): 2^15

每个Mesh网络中的群组地址数量: 2^14

每个Mesh网络中的虚拟地址数量: 2^46

每个Mesh网络中的应用数量: 2^12

每个Mesh网络中的子网数量: 2^12

每个Mesh网络每个元素可发送的消息数量: 2^56

Mesh网络数量: 2^128

### JDY-25M模块简介

JDY-25M 超级蓝牙功能支持主从透传，iBeacon，BLE 探针，iBeacon 探测，MESH 组网，
MESH 组网数量最大支持 65280 设备组网，采用多跳无线防碰撞技术，组网通信速度支持 50mS
发 12 字节数据，单模块支持路由节点与终端节点，路由节点支持数据中继（不支持低功耗），
终端节点支持低功耗（按键唤醒发完数据后自动睡眠），JDY-25M 组网一般只需要配置好组
网 NETID、短地址后，模块将会自动组网，组网模块与 APP 通信时相当于透传，这样极大
的方便用户开发 APP 与老产品的 APP 兼容。

![image-20231206112741984](https://woniumd.oss-cn-hangzhou.aliyuncs.com/aiot/luozhaoyong/image-20231206112741984.png)

#### 产品特点

1. 支持与手机（IOS、ANDROID）APP 数据透传（工作电流 1mA 左右）
2. 支持模块与模块主从高速透传
3. 支持 iBeacon 功能（超低功耗）
4. 支持 iBeacon 探针功能
5. 支持 BLE 蓝牙探针功能
6. 支持多连从机模式，多连从机可与多个手机连接，同时透传
7. 支持蓝牙 MESH（组网串口数据通信，输出 IO 控制，输入按键控制）组网
8. MESH 组网发送数据支持应答与无应答通信
9. 组网遥控器
10. 多连主从机混连(主机同时连接从机，从机同时被连接手机，同时工作）

#### 引脚定义

![image-20231206112724609](https://woniumd.oss-cn-hangzhou.aliyuncs.com/aiot/luozhaoyong/image-20231206112724609.png)

#### 测试

![image-20231206113403069](https://woniumd.oss-cn-hangzhou.aliyuncs.com/aiot/luozhaoyong/image-20231206113403069.png)

**设备 1 参数配置**

1. JDY-25M 默认波特率是 9600，所以在串口工具上选择波特率为：9600
2. 勾上 发送回车 选项
3. 配置成组网模式：AT+ROLE5
4. 配置组网 ID 号为 1122，发 AT+NETID1122（一般测试的话可以使用默认出厂参数，这一
   项可以不配置），实际产品应用的话，一般不建议使用出厂配置参数
5. 配置设备短地址为 0004，发 AT+MADDR0004（一般测试的话可以使用默认出厂参数，这
   一项可以不配置），出厂短地址为 MAC 地址后两位，同一批货，一般后两位的 MAC 地
   址都是唯一的，实际产品应用的话，一般建议用户自己配置短地址
6. 发送 AT+RESET 复位重启，重启后模块将生效以上配置的参数

**设备 2 参数配置**

1. JDY-24M/25M 默认波特率是 9600，所以在串口工具上选择波特率为：9600
2. 勾上 发送回车 选项
3. 配置成组网模式：AT+ROLE5
4. 配置组网 ID 号为 1122，发 AT+NETID1122（一般测试的话可以使用默认出厂参数，这一
   项可以不配置），实际产品应用的话，一般不建议使用出厂配置参数
5. 配置设备短地址为 0005，发 AT+MADDR0004（一般测试的话可以使用默认出厂参数，这
   一项可以不配置），出厂短地址为 MAC 地址后两位，同一批货，一般后两位的 MAC 地
   址都是唯一的，实际产品应用的话，一般建议用户自己配置短地址
6. 发送 AT+RESET 复位重启，重启后模块将生效以上配置的参数
   通过以上步骤配置后，说明两个模块之间已经组网，如用户需要通过 IO 判断当前设备有没
   有组网成功，可以在网络内放一台中心机，配置中心机只需要将模块的短地址配置成 0001
   就行，配置后重启， 这样网络内组网的设备的 STAT 引脚将会输出组网状态电平，组网成功
   STAT 引脚输出高电平，未组网 STAT 引脚输出低电平
   中心机支持所有路由器功能，中心机也可以向设备自动分布短地址，由于此方法太过于复杂，
   一般建议用户发送 AT+MADDR 指令配置

#### 设备通信

![image-20231206113623894](https://woniumd.oss-cn-hangzhou.aliyuncs.com/aiot/luozhaoyong/image-20231206113623894.png)

设备 1 接收数据，设备 2 发送数据
设备 2 发送的数据内容是：

> 11223344

设备 1 接收的数据：

> f1 dd 0a 00 05 ff ff 11 22 33 44 0d 0a

接收数据格式说明：

> f1dd 表示数据头
> 0a 表示后面数据长度
> 0005 表示此数据是 0005 设备发过来的数据
> ffff 表示此包数据是以广播的方式发出
> 11223344 表示为数据内容
> 0d0a 表示结束符

串口工具设置中文广播名例子

![image-20231206113759455](https://woniumd.oss-cn-hangzhou.aliyuncs.com/aiot/luozhaoyong/image-20231206113759455.png)

串口工具设置英文广播名例子

![image-20231206113846400](https://woniumd.oss-cn-hangzhou.aliyuncs.com/aiot/luozhaoyong/image-20231206113846400.png)

设置完成后，再发 AT+RESET 重启生效

#### AT指令

JDY-25M 模块串口发送 AT 指令务必加上\r\n
![image-20231206112935184](https://woniumd.oss-cn-hangzhou.aliyuncs.com/aiot/luozhaoyong/image-20231206112935184.png)

![image-20231206113003414](https://woniumd.oss-cn-hangzhou.aliyuncs.com/aiot/luozhaoyong/image-20231206113003414.png)



