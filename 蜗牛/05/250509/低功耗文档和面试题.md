## 一、低功耗基础

1、参考上课时的视频和官方参考手册的第四章，电源控制，完整理解低功耗模式的基础

![image-20241118093048387](https://gitee.com/zhangshoudao/pic_bed/raw/master/img/202411180930549.png)

## 二、HAL库如何操作（参考）

（STOP)停止模式：1.2V domain 中的所有 clocks 都被停止，PLL、HSI 和 HSE RC oscillators 被禁用。内部 SRAM 和寄存器内容被保留(所以再次启动的时候可以接着运行原来的程序）。稳压器可以配置为正常或低功耗模式。为了最大限度地减少消耗 在 Stop 模式下，使用 HAL_PWREx_EnableFlashPowerDown（） 函数在进入 Stop 模式之前关闭 FLASH。

使用 HAL_PWREx_DisableFlashPowerDown（） 功能退出停止模式后，可以通过软件再次打开它。     HAL_PWR_EnterSTOPMode（PWR_Regulator_LowPower,PWR_STOPEntry_WFI），
其中参数：
PWR_Regulator_LowPower：低功耗
PWR_STOPENTRY_WFI：通过WFI进入STOP模式，意味着任意的EXTI（内部或者外部）的被使能过的中断都能把MCU从STOP模式唤醒。

## 三、FreeRTOS操作系统——低功耗Tickless模式

参考文档：https://blog.csdn.net/qq_51963216/article/details/122775605

## 四、常见面试问题

### 1:什么时候会进入低功耗模式？
答:长时间不操作设备（获取操作系统的tick），如果20s后没有UI界面的操作，那么就进入（低功耗模式）睡眠模式。

具体的回答

> **进入低功耗模式的触发条件**：
>
> - 当系统长时间没有接收到操作（例如用户输入、触摸屏、按钮按压等），且没有其他重要任务需要处理时，STM32单片机可以进入低功耗模式。
> - 具体来说，如果**20秒内没有任何UI界面操作**或设备没有响应输入事件，系统会判断当前处于空闲状态，从而决定进入低功耗模式（如睡眠模式）。
>
> **低功耗模式的目的**：
>
> - **节省能量**：让系统在不需要活跃运行时减少功耗，降低能耗。
> - **保证实时性**：进入低功耗模式后，设备可以根据需要快速唤醒，响应新的输入事件或任务。

### 2:进入低功耗的时候，有没有把其他的外围电路做一些处理？
答：进入低功耗模式之前，需要将LCD屏幕熄灭（显示屏的背光PWM的占空比设置为0）以及相关外设进入低功耗模式。

> **外围电路的处理**：
> 在进入低功耗模式之前，STM32单片机会采取措施来减少不必要的功耗，具体包括以下几个方面：
>
> 1. **关闭LCD屏幕背光**：
>    - LCD屏幕通常是功耗较大的外设，尤其是屏幕背光。在进入低功耗模式之前，需要将屏幕熄灭，通常通过设置背光的**PWM占空比为0**来关闭背光，从而减少屏幕的功耗。
> 2. **进入外设低功耗模式**：
>    - STM32支持多种外设的低功耗管理，例如：
>      - **关闭不必要的外设时钟**：通过关闭不再使用的外设时钟，来减少其功耗。
>      - **外设掉电**：对不需要工作的外设（如ADC、DMA、USART等）可以通过掉电或者进入待机模式，进一步降低功耗。
>      - **进入低功耗模式的外设**：一些外设（如RTC、定时器等）可以继续工作，在低功耗模式下也能保持基本功能，但功耗会大大降低。
> 3. **调整系统时钟**：
>    - 系统时钟可以在进入低功耗模式时被调低或关闭，降低时钟频率有助于减少功耗。在进入低功耗模式时，STM32会自动切换到低频时钟源，甚至可以完全关闭主时钟，让CPU进入“休眠”状态。

### 3：如何设计你的低功耗模型

> ### 1. **软件优化：异步实现**
>
> - **意义**：在软件层面，低功耗的实现需要通过优化程序运行方式。例如，让应用程序（apps）和驱动程序尽量异步执行，而不是一直保持同步运行。
> - **原理**：同步运行会让所有任务都需要等待，导致系统频繁工作，增加功耗；而异步执行允许任务在不同时段运行，CPU可以在空闲时进入低功耗模式，节省能量。
>
> ### 2. **硬件优化：关闭时钟、掉电外设**
>
> - **关闭时钟**：在STM32中，每个外设都有自己的时钟源，如果某些外设暂时不使用，可以通过关闭对应的时钟来降低功耗。
> - **掉电外设**：STM32提供了一些电源模式（如睡眠模式、待机模式、停机模式等）。在不需要某些外设功能时，可以通过关闭这些外设的电源（断电）来减少功耗。
>
> ### 3. **功耗模型与待机时间优化**
>
> - **功耗模型**：这是对设备在不同运行状态下功耗的分析和建模。通过明确不同状态的功耗，可以制定更加精准的优化策略。
> - **待机时间优化**：根据设备的使用场景和任务需求，调整待机时长和唤醒频率。例如，延长不必要的唤醒时间，减少唤醒次数，可以显著降低整体功耗。

### 4、进入低功耗后，电流为多少

> 以STM32F411CEU6 STM32F4 核心板为例，板子正常工作是20mA（含外设）,加上传感器后的功耗为90ma，比如屏幕，通信模块等。进入低功耗是1.7μa。

具体回答：

> ### 1. **进入低功耗前的电流**：
>
> - 普通运行模式
>   - **电流范围**：大约为 **10-30 mA**，具体值取决于主频（最高100 MHz）、外设数量和外设的工作状态（如LCD、UART等是否开启）。
>   - **功耗来源**：包括内核运行功耗、外设运行功耗以及外部电路（如屏幕、传感器、通信模块等）的耗电。
>
> ### 2. **进入低功耗模式后的电流**：
>
> STM32F411CEU6提供了多种低功耗模式，具体电流如下（以典型条件为例，电压为3.3V，25°C）：
>
> - **睡眠模式**（Sleep Mode）：
>   - CPU停止运行，但外设时钟可以继续工作，外设根据需要开启。
>   - **电流**：约 **1-2 mA**（视外设情况而定）。
> - **低功耗睡眠模式**（Low-Power Sleep Mode）：
>   - 与睡眠模式类似，但主时钟（HCLK）和系统时钟（SYSCLK）可以降低频率或关闭。
>   - **电流**：约 **0.3-0.5 mA**。
> - **停止模式**（Stop Mode）：
>   - CPU和大部分外设停止运行，仅保留低频外设（如RTC）。
>   - **电流**：约 **2-5 µA**。
> - **待机模式**（Standby Mode）：
>   - 所有外设停止，仅保留少量功能（如唤醒引脚、RTC）。
>   - **电流**：约 **1-2 µA**。
>
> ### 3. **实际对比**：
>
> 假设你的板子在运行模式下耗电约为 **20 mA**（含外设），进入低功耗模式后：
>
> - **睡眠模式**：电流可能降到 **10 mA** 左右。
> - **停止模式**：电流可能降到 **2-5 µA** 左右。
> - **待机模式**：电流最低，约 **1-2 µA**。
>
> ### **总结**：
>
> - **进入低功耗前**：电流主要取决于主频和外设活动状态，通常在 **10-30 mA**。
> - **进入低功耗后**：根据模式不同，电流可能降至 **10 mA、数百 µA 或几 µA**。其中，待机模式耗电最低。

